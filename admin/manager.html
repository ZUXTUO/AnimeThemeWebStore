<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单管理</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #2c2c2c;
            color: #f9f9f9;
        }
        h1, h2 {
            color: #f9f9f9;
        }
        #order-list {
            background: #3c3c3c;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #555;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #4c4c4c;
        }
        .editable {
            width: 100%;
            background-color: #444;
            color: #f9f9f9;
            border: 1px solid #555;
            border-radius: 5px;
            padding: 5px;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        button:hover {
            background-color: #218838;
        }
        .image-gallery {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .image-gallery img {
            width: 100px;
            height: auto;
            margin-right: 10px;
            cursor: pointer;
        }
        #pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .page-item {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.3s;
        }
        .page-item:hover {
            background-color: #218838;
        }
        .page-item.active {
            background-color: #218838;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>订单管理</h1>
    <div id="order-list">
        <h2>订单列表</h2>
        <label for="order-status-filter">筛选订单状态：</label>
        <select id="order-status-filter" onchange="filterOrders()">
            <option value="">所有状态</option>
            <option value="0">未支付</option>
            <option value="1">已支付，审核中</option>
            <option value="2">已支付，审核成功</option>
            <!-- <option value="3">确认成品信息</option> -->
            <!-- <option value="4">已确认成品信息</option> -->
            <!-- <option value="5">待支付尾款信息</option> -->
            <!-- <option value="6">已支付尾款信息，审核中</option> -->
            <!-- <option value="7">已支付尾款信息，审核成功</option> -->
            <option value="8">待发货</option>
            <option value="9">已发货</option>
            <option value="10">已送达</option>
            <option value="11">已收货</option>
            <option value="12">超时未支付，订单关闭</option>
            <option value="13">已售后</option>
            <option value="14">已退款</option>
            <option value="15">订单关闭</option>
            <option value="16">已支付，但退款中</option>
            <option value="17">已支付，退款成功</option>
        </select>
        
        <button style="background-color: #dc3545; color: white;" onclick="location.href='index.html'">商品管理</button>
        <table>
            <thead>
                <tr>
                    <th>订单编号</th>
                    <th>用户 ID</th>
                    <th>商品代号</th>
                    <th>商品名</th>
                    <th>数量</th>
                    <th>状态</th>
                    <th>下单时间</th>
                    <th>收件人姓名</th>
                    <th>手机号</th>
                    <th>收货地址</th>
                    <th>运单号</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="orders"></tbody>
        </table>
        <div id="pagination"></div>
        <button style="background-color: #dc8e35; color: white;" onclick="logout()">登出</button>
    </div>

    <script>
        let currentPage = 1;
        const itemsPerPage = 10;
        let totalOrders = 0;
        let selectedStatus = '';

        window.onload = function() {
            const merchantId = localStorage.getItem('merchantId');
            if (merchantId) {
                loadOrders(merchantId);
            } else {
                alert('请先登录');
                window.location.href = 'index.html';
            }
        };

        async function loadOrders(merchantId) {
            const response = await fetch(`../php/admin/getOrders.php?merchantId=${merchantId}&page=${currentPage}&limit=${itemsPerPage}&status=${selectedStatus}`);
            const result = await response.json();
            const orders = result.orders;
            totalOrders = result.total;
            const orderList = document.getElementById('orders');
            orderList.innerHTML = '';

            for (const order of orders) {
                const row = document.createElement('tr');
                row.setAttribute('data-order-id', order.Id);
                row.innerHTML = `
                    <td>${order.Id}</td>
                    <td>${order.user_id}</td>
                    <td>${order.commodity_id}</td>
                    <td>${order.commodity_title}</td>
                    <td>${order.num}</td>
                    <td>
                        <select class="editable" onchange="updateOrder(${order.Id}, 'order_status', this.value)">
                            ${getOrderStatusOptions(order.order_status)}
                        </select>
                    </td>
                    <td>${order.order_time}</td>
                    <td><input type="text" class="editable" value="${order.consignee_name}" onchange="updateOrder(${order.Id}, 'consignee_name', this.value)"></td>
                    <td><input type="text" class="editable" value="${order.phone_number}" onchange="updateOrder(${order.Id}, 'phone_number', this.value)"></td>
                    <td><input type="text" class="editable" value="${order.delivery_address}" onchange="updateOrder(${order.Id}, 'delivery_address', this.value)"></td>
                    <td><input type="text" class="editable" value="${order.waybill_number}" onchange="updateOrder(${order.Id}, 'waybill_number', this.value)"></td>
                    <td><button onclick="syncOrder(${order.Id})">同步</button></td>`;
                
                orderList.appendChild(row);

                const images = await loadImages(order.Id);
                const imageRow = document.createElement('tr');
                const imageCell = document.createElement('td');
                imageCell.colSpan = 12;
                const imageGallery = document.createElement('div');
                imageGallery.className = 'image-gallery';

                images.forEach(image => {
                    const img = document.createElement('img');
                    img.src = `../order/${order.Id}/${image}`;
                    img.onclick = () => window.open(img.src);
                    imageGallery.appendChild(img);
                });

                imageCell.appendChild(imageGallery);
                imageRow.appendChild(imageCell);
                orderList.appendChild(imageRow);
            }

            generatePagination(Math.ceil(totalOrders / itemsPerPage));
        }

        async function loadImages(orderId) {
            const response = await fetch(`../php/admin/getOrderImages.php?orderId=${orderId}`);
            const images = await response.json();
            return images;
        }

        function getOrderStatusOptions(selectedStatus) {
            const statusMap = {
                0: "未支付",
                1: "已支付，审核中",
                2: "已支付，审核成功",
                // 3: "确认成品信息",
                // 4: "已确认成品信息",
                // 5: "待支付尾款信息",
                // 6: "已支付尾款信息，审核中",
                // 7: "已支付尾款信息，审核成功",
                8: "待发货",
                9: "已发货",
                10: "已送达",
                11: "已收货",
                12: "超时未支付，订单关闭",
                13: "已售后",
                14: "已退款",
                15: "订单关闭",
                16: "已支付，但退款中",
                17: "已支付，退款成功"
            };

            return Object.entries(statusMap).map(([key, value]) =>
                `<option value="${key}" ${selectedStatus == key ? 'selected' : ''}>${value}</option>`
            ).join('');
        }

        const orderUpdates = {};

        function updateOrder(orderId, fieldName, value) {
            if (!orderUpdates[orderId]) {
                orderUpdates[orderId] = {};
            }
            orderUpdates[orderId][fieldName] = value;
        }

        function syncOrder(orderId) {
            const orderData = {
                orderId: orderId,
                ...orderUpdates[orderId]
            };

            fetch('../php/admin/syncOrder.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            }).then(response => response.json())
              .then(result => {
                  alert(result.message);
                  if (result.success) {
                      delete orderUpdates[orderId];
                  }
              });
        }

        function generatePagination(totalPages) {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';

            const prevButton = document.createElement('button');
            prevButton.innerText = '«';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => changePage(currentPage - 1);
            paginationContainer.appendChild(prevButton);

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.innerText = i;
                button.onclick = () => changePage(i);
                if (i === currentPage) {
                    button.disabled = true;
                }
                paginationContainer.appendChild(button);
            }

            const nextButton = document.createElement('button');
            nextButton.innerText = '»';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => changePage(currentPage + 1);
            paginationContainer.appendChild(nextButton);
        }

        function changePage(newPage) {
            currentPage = newPage;
            const merchantId = localStorage.getItem('merchantId');
            loadOrders(merchantId);
        }

        function filterOrders() {
            selectedStatus = document.getElementById('order-status-filter').value;
            currentPage = 1;
            const merchantId = localStorage.getItem('merchantId');
            loadOrders(merchantId);
        }

        function logout() {
            localStorage.removeItem('merchantId');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
